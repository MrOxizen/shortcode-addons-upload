(function($) {

	$.SAVideoPlayer = function(element, options) {

		var defaults = {
			cover				: '.sa-el-player__cover',
			
			volume 				: 0.5,
			speed 				: 1,
			controls			: '.sa-el-player__controls',
			bar 				: '.sa-el-player__controls__bar-wrapper',
			controlPlay			: '.sa-el-player__controls__play',
			controlRewind		: '.sa-el-player__controls__rewind',
			controlFullScreen 	: '.sa-el-player__controls__fs',
			controlTime 		: '.sa-el-player__controls__time',
			controlDuration 	: '.sa-el-player__controls__duration',
			controlProgressBar 	: '.sa-el-player__controls__progress',
			controlProgress		: '.sa-el-player__controls__progress-time',
			controlVolumeBar 	: '.sa-el-player__controls__volume-bar',
			controlVolume 		: '.sa-el-player__controls__volume-bar__amount',
			controlVolumeIcon 	: '.sa-el-player__controls__volume-icon',

			overlays 			: '.sa-el-player__controls__overlay',

			restartOnPause		: false,
			stopOthersOnPlay 	: false,
			playOnViewport		: false,
			stopOffViewport		: false,
			endAtLastFrame 		: false,
		};

		var plugin = this;

		plugin.opts = {};

		var $document 			= $(document),
			$wrapper			= $(element),
			$video 				= $wrapper.find('> video'),
			video 				= $video.get(0),
			cover 				= null,
			$cover				= null,

			$controls			= null,
			$bar 				= null,
			$controlPlay		= null,
			$controlRewind		= null,
			$controlFullScreen 	= null,
			$controlTime 		= null,
			$controlDuration 	= null,
			$controlProgressBar = null,
			$controlProgress	= null,
			$controlVolumeBar 	= null,
			$controlVolume 		= null,
			$controlVolumeIcon 	= null,

			controlRewind 		= null,
			controlPlay 		= null,
                        

			volume                  = null,
                        playbackRate            = null,

			source				= $video.attr('src'),

			_is_autoplay 		= $video.is("[autoplay]"),
			_is_dragging_time 	= false,
			_is_dragging_volume = false,
			_is_playing			= false,
			_is_loaded 			= false,
			_is_ios 			= /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream,
			_is_ios_played 		= false,

			_drag_time_amount 	= 0;

              
		plugin.init = function() {
			plugin.opts = $.extend({}, defaults, options);
			plugin._construct();
		};

		plugin._construct = function() {

			$cover				= $wrapper.find( plugin.opts.cover );
			$controls			= $wrapper.find( plugin.opts.controls );
			$bar 				= $wrapper.find( plugin.opts.bar );

			$controlRewind		= $controls.find( plugin.opts.controlRewind );
			$controlPlay		= $controls.find( plugin.opts.controlPlay );
			$controlFullScreen 	= $controls.find( plugin.opts.controlFullScreen );
			$controlDuration 	= $controls.find( plugin.opts.controlDuration );
			$controlTime 		= $controls.find( plugin.opts.controlTime );
			$controlProgress	= $controls.find( plugin.opts.controlProgress);
			$controlProgressBar = $controls.find( plugin.opts.controlProgressBar);
			$controlVolume		= $controls.find( plugin.opts.controlVolume);
			$controlVolumeBar 	= $controls.find( plugin.opts.controlVolumeBar);
			$controlVolumeIcon 	= $controls.find( plugin.opts.controlVolumeIcon);

			volume 				= plugin.opts.volume;
			playbackRate		= plugin.opts.speed;

			cover 				= $cover.get(0);

			if ( $controls.length ) {
				controlPlay 	= $controlPlay.get(0);

				if ( $controlRewind.length )
				controlRewind 	= $controlRewind.get(0);
			}

			video.load();

			plugin.events();

			plugin.initViewportPlay();

			plugin.initProgressBar();

			plugin.initVolumeBar();
		};

		plugin.events = function() {

			if ( $controlPlay.length )
				$controlPlay.on( 'click', plugin.maybePlay );

			if ( $cover.length )
				$cover.on( "click", plugin.maybePlay );

			if ( $controlRewind.length )
				$controlRewind.on( "click", plugin.maybeRewind );

			if ( $controlFullScreen.length )
				$controlFullScreen.on( "click", function(e) {
					e.preventDefault();
					plugin.fullscreen();
				});

			video.addEventListener( "loadedmetadata", plugin.initVideo );
			video.addEventListener( 'timeupdate', plugin.updateTime );
			video.addEventListener( 'canplaythrough', plugin.canPlayThrough );
			
			video.addEventListener( 'ended', plugin.ended );
			video.defaultPlaybackRate = playbackRate;

			if( _is_ios ) {
				$video.on( 'webkitExitFullscreen', plugin.stop );
			}

		};

		plugin.canPlayThrough = function() {
			_is_loaded = true;
		};

		plugin.ended = function() {
			plugin.stop( false );

			$wrapper.trigger( 'ee:video-player:ended', [ plugin ] );
		};

		plugin.initVideo = function() {
			var initialVolume = 'true' === $video.attr( 'muted' ) ? 0 : volume;

			video.playbackRate = playbackRate;

			plugin.updateVolume( 0, initialVolume );
			plugin.updateDuration();

			if ( _is_autoplay ) {
				plugin.beforePlay();
				plugin.afterPlay();
			}
		};

		plugin.initProgressBar = function() {
			if ( $controlProgressBar.length ) {

				$controlProgressBar.on( 'mousedown', function(e) {
					_is_dragging_time = true;
					plugin.updateProgress( e.pageX );
				});

				$document.on( 'mouseup', function(e) {
					if( _is_dragging_time ) {
						_is_dragging_time = false;
						plugin.updateProgress( e.pageX );
					}
				});

				$document.on('mousemove', function(e) {
					if( _is_dragging_time ) {
						plugin.updateProgress( e.pageX );
					}
				});
			}
		};

		plugin.initVolumeBar = function() {

			if ( $controlVolumeIcon.length ) {

				$controlVolumeIcon.click( function(e) {
					e.preventDefault();

					if ( video.volume == 0 ) {
						if ( volume == 0 ) volume = plugin.opts.volume;
						video.muted = false;

						plugin.updateVolume( 0, volume );

					} else { 

						var _volume = video.volume;

						plugin.updateVolume( 0, 0 );
						
						volume = _volume;
					}
				});

			}

			if ( $controlVolumeBar.length ) {

				$controlVolumeBar.on( 'mousedown', function(e) {
					_is_dragging_volume = true;
					video.muted = false;

					plugin.updateVolumeIcon( 1 );
					
					plugin.updateVolume( e.pageX );
				});

				$document.on( 'mouseup', function(e) {
					if( _is_dragging_volume ) {
						_is_dragging_volume = false;
						plugin.updateVolume( e.pageX );
					}
				});

				$document.on( 'mousemove', function(e) {
					if( _is_dragging_volume ) {

						plugin.updateVolume( e.pageX );
					}
				});

			}
		};

		plugin.initViewportPlay = function() {
			$wrapper._appear({ force_process: true });
			if (  plugin.opts.playOnViewport ) {
				$wrapper.on( '_appear', function() { plugin.play(); });

				if ( plugin.opts.stopOffViewport )
				$wrapper.on( '_disappear', function() { plugin.stop( true ); });
			}
		};

		plugin.beforePlay = function() {
			$controlPlay.removeClass('fas fa-play').addClass('fas fa-pause');
		};

		plugin.play = function() {

			if ( _is_playing )
				return;

			plugin.beforePlay();

			$wrapper.trigger( 'ee:video-player:beforePlay', [ plugin ] );

			
			video.play();
			plugin.afterPlay();

			$wrapper.trigger( 'ee:video-player:afterPlay', [ plugin ] );
		};

		plugin.afterPlay = function() {
			
			$wrapper.removeClass('paused').addClass('playing');

			
			_is_playing = true;

			
			if ( plugin.opts.stopOthersOnPlay ) {
				var $players = $('.sa-el-video-player').not(element);

				$players.each( function() {
					var instance = $(this).data('videoPlayer');

					instance.stop( true );
				});
			}
		};

		plugin.stop = function( pausing ) {

			if ( ! _is_playing )
				return;
			
			$wrapper.removeClass('playing');

			$controlPlay.removeClass('fas fa-pause').addClass('fas fa-play');

			if ( ! _is_playing )
				return;

			if ( pausing ) { 

				
				$wrapper.addClass('paused');

				
				video.pause();

				if ( plugin.opts.restartOnPause )
					video.currentTime = 0; 

			} else { 

				if ( ! plugin.opts.endAtLastFrame ) {
					video.currentTime = 0;
				}
			}

			_is_playing = false;

			$wrapper.trigger( 'ee:video-player:stop', [ plugin ] );
		};

		plugin.maybeRewind = function() {
			video.currentTime = 0;
			plugin.play();

			$wrapper.trigger( 'ee:video-player:rewind', [ plugin ] );
		};

		plugin.maybePlay = function( event ) {

			if ( ! _is_playing ) {
				plugin.play();
			} else {
				plugin.stop( true );
			}

			return false;
		};

		plugin.fullscreen = function() {

			if ( video.requestFullscreen ) {
			    video.requestFullscreen();
			} else if ( video.webkitRequestFullscreen ) {
			    video.webkitRequestFullscreen();
			} else if ( video.webkitEnterFullscreen ) {
				video.webkitEnterFullscreen();
			} else if ( video.mozRequestFullScreen ) {
			    video.mozRequestFullScreen();
			} else if ( video.msRequestFullscreen ) {
			    video.msRequestFullscreen();
			} else {
				alert('Your browser doesn\'t support fullscreen');
			}
		};

		plugin.updateTime = function() {

			var position 	= video.currentTime,
				duration 	= video.duration,
				percentage 	= 100 * position / duration;

			if ( $controlProgress)
				$controlProgress.css( 'width', percentage + '%' );

			
			if ( $controlTime.length )
				$controlTime.html( plugin.formatTime( position ) );
		};

		plugin.updateDuration = function() {

			var duration 	= video.duration;

			
			if ( $controlDuration.length )
				$controlDuration.html( plugin.formatTime( duration ) );
		};

		plugin.updateProgress = function( amount ) {

			var duration 	= video.duration,
				position 	= amount - $controlProgressBar.offset().left,
				percentage 	= 100 * position / $controlProgressBar.width();

			if ( percentage > 100 ) percentage = 100;
				else if ( percentage < 0 )
					percentage = 0;

			$controlProgress.css( 'width', percentage + '%');

			video.currentTime = duration * percentage / 100;
		};

		plugin.updateVolume = function( amount, volume ) {
			var percentage;

			if( volume ) {
				percentage = volume * 100;
			} else {

				var offsetLeft = ( $controlVolumeBar.length ) ? $controlVolumeBar.offset().left : 1,
					position = amount - offsetLeft,
					percentage = 100 * position / $controlVolumeBar.width();
			}
			
			if ( percentage > 100 ) percentage = 100;
				else if ( percentage < 0 )
					percentage = 0;

		
			video.volume = percentage / 100;

			plugin.updateVolumeIcon( video.volume );
			
			
			$controlVolume.css( 'width',percentage + '%' );

			
			volume = video.volume;
		};

		plugin.updateVolumeIcon = function( vol ) {
			if ( vol == 0 )
				$controlVolumeIcon.addClass('fas fa-volume-mute').removeClass('fas fa-volume-up');
			else
				$controlVolumeIcon.addClass('fas fa-volume-up').removeClass('fas fa-volume-mute');
		};
		plugin.formatTime = function( seconds ) {
			minutes = Math.floor(seconds / 60);
		    minutes = (minutes >= 10) ? minutes : "0" + minutes;
		    seconds = Math.floor(seconds % 60);
		    seconds = (seconds >= 10) ? seconds : "0" + seconds;
		    return minutes + ":" + seconds;
		};

		plugin.init();

	};

	$.fn.SAVideoPlayer = function(options) {

		return this.each(function() {
			if (undefined == $(this).data('SAVideoPlayer')) {
				var plugin = new $.SAVideoPlayer(this, options);
				$(this).data('SAVideoPlayer', plugin);
			}
		});

	};

})(jQuery);
